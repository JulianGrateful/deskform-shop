<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Deskform App | Fix Categories</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --card-bg: #ffffff; --text-main: #111827; }
        body { font-family: sans-serif; background: var(--bg); padding-bottom: 160px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        .header-wrapper { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); transition: transform 0.3s; }
        .header-wrapper.hidden { transform: translateY(-100%); }
        .cat-scroll-container { display: flex; flex-direction: column; gap: 8px; padding-bottom: 8px; }
        .scroll-row { overflow-x: auto; white-space: nowrap; padding: 0 4px; display: flex; gap: 8px; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }
        
        /* PILLS */
        .pill-mode { padding: 8px 16px; background: #fff; border-radius: 20px; font-weight: 800; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; }
        .pill-mode.active { background: #111827; color: white; border-color: #111827; }
        .pill-l1 { padding: 6px 14px; background: #fff; border-radius: 18px; font-size: 0.9rem; font-weight: 700; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .pill-l1.active { background: var(--primary); color: white; border-color: var(--primary); }
        .pill-l2 { padding: 5px 12px; background: #E0F2FE; color: #0369A1; border-radius: 14px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .pill-l2.active { background: #0284C7; color: white; }
        .pill-l3 { padding: 4px 10px; background: #F3F4F6; color: #6B7280; border-radius: 12px; font-size: 0.8rem; font-weight: 500; cursor: pointer; }
        .pill-l3.active { background: #10B981; color: white; }

        .search-container { padding: 10px 16px; }
        .search-input-group { border-radius: 12px; background: #fff; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; }
        .container-main { padding-top: 240px; }

        /* CARDS */
        .product-card { background: #fff; border-radius: 16px; overflow: hidden; height: 100%; position: relative; cursor: pointer; }
        .img-wrapper { height: 160px; padding: 10px; display: flex; justify-content: center; align-items: center; position: relative; }
        .img-wrapper img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .chip-brand { position: absolute; top: 8px; left: 8px; background: #F3F4F6; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
        .cart-indicator { position: absolute; bottom: 8px; right: 8px; background: var(--primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: 700; }
        .card-info { padding: 10px; }
        .card-title { font-size: 0.85rem; font-weight: 500; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 4px; }
        .price-curr { font-size: 1rem; font-weight: 800; }
        
        /* FOOTER */
        .bottom-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid rgba(0,0,0,0.1); z-index: 990; padding-bottom: env(safe-area-inset-bottom); }
        .bottom-panel.hidden { transform: translateY(100%); }
        .footer-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 10px 16px 15px; }
        .btn-order { background: rgba(0,122,255,0.1); color: var(--primary); border: 1px solid rgba(0,122,255,0.2); border-radius: 12px; padding: 8px 16px; font-weight: 700; }
        
        /* LOGISTICS UI */
        .delivery-option { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e5e5ea; border-radius: 12px; margin-bottom: 8px; cursor: pointer; }
        .delivery-option.selected { border-color: var(--primary); background: rgba(0,122,255,0.05); }
        
        /* Loader */
        #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loaderOverlay"><div class="spinner-border text-primary mb-3"></div><div>–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã...</div></div>

<div class="header-wrapper" id="mainHeader">
    <div class="container pt-2 pb-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">Deskform Dealer</div>
            <div class="d-flex gap-2">
                <span class="badge bg-warning text-dark" id="userStatusChip">...</span>
                <button class="btn btn-sm btn-light rounded-pill" onclick="resetFilters()">–°–±—Ä–æ—Å</button>
            </div>
        </div>
        <div class="input-group mb-2 search-input-group">
            <span class="input-group-text border-0 bg-white"><i class="bi bi-search"></i></span>
            <input type="text" id="searchInput" class="form-control border-0 shadow-none" placeholder="–ü–æ–∏—Å–∫...">
        </div>
        <div class="cat-scroll-container">
            <div id="rowMode" class="scroll-row"></div>
            <div id="rowL2" class="scroll-row"></div>
            <div id="rowL3" class="scroll-row"></div>
            <div id="rowL4" class="scroll-row"></div>
        </div>
    </div>
</div>

<div class="container container-main">
    <div id="productsGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-2"></div>
    <div id="scrollSentinel" class="text-center py-5 opacity-0">.</div>
    <div id="emptyState" class="text-center py-5 d-none">–ü—É—Å—Ç–æ</div>
</div>

<div class="bottom-panel" id="mainFooter">
    <div class="footer-grid">
        <div></div>
        <div class="text-center">
            <div style="font-size:0.7rem;color:#6B7280">–°—É–º–º–∞: <span class="fw-bold text-dark" id="footerBaseSum">0</span></div>
            <div style="font-size:0.8rem;color:#10B981;font-weight:700">–í—ã–≥–æ–¥–∞: <span id="footerBenefit">0</span></div>
        </div>
        <button class="btn-order" data-bs-toggle="modal" data-bs-target="#cartModal">–ö–æ—Ä–∑–∏–Ω–∞ <span id="cartCountBadge" class="badge bg-primary ms-1" style="display:none">0</span></button>
    </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button><div class="img-wrapper mb-3"><img id="modalImg" src=""></div><h5 id="modalTitle" class="fw-bold mb-1"></h5><div class="text-muted small mb-3">–ê—Ä—Ç–∏–∫—É–ª: <span id="modalArt" class="fw-bold text-dark"></span></div><div class="d-flex justify-content-between mb-2"><span class="text-muted small">–†–æ–∑–Ω–∏—Ü–∞:</span><span class="text-decoration-line-through text-muted" id="modalRetailPrice"></span></div><div class="d-flex justify-content-between mb-3"><span class="fw-bold">–û–ø—Ç:</span><span class="fs-4 fw-bold text-primary" id="modalDealerPrice"></span></div><div class="bg-light p-3 rounded-3"><div class="d-flex justify-content-center mb-3"><div class="btn-group w-100"><input type="radio" class="btn-check" name="qtyMode" id="modeUnit" onchange="updateCalc()" checked><label class="btn btn-outline-secondary" for="modeUnit">–®—Ç.</label><input type="radio" class="btn-check" name="qtyMode" id="modeBox" onchange="updateCalc()"><label class="btn btn-outline-secondary" for="modeBox">–ö–æ—Ä. <span id="boxLabel"></span></label></div></div><div class="d-flex align-items-center justify-content-between"><button class="btn btn-white border" onclick="adjustQty(-1)" style="width:40px;height:40px">-</button><input type="number" id="qtyInput" class="form-control text-center mx-2 border-0 bg-transparent fs-2 fw-bold" value="0" oninput="updateCalc()"><button class="btn btn-white border" onclick="adjustQty(1)" style="width:40px;height:40px">+</button></div><div class="text-center mt-2 small text-muted">–ò—Ç–æ–≥–æ: <span id="calcTotalPrice" class="fw-bold text-dark">0</span></div></div><button class="btn btn-primary w-100 mt-3 py-3 rounded-3 fw-bold" onclick="confirmAddToCart()">–î–æ–±–∞–≤–∏—Ç—å</button></div></div></div></div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-light">
            <div class="modal-header border-0 pb-0"><h5 class="fw-bold ms-2">–ö–æ—Ä–∑–∏–Ω–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-3">
                <div id="cartItemsList"></div>
                <div id="cartEmptyMsg" class="text-center py-5 text-muted">–ü—É—Å—Ç–æ</div>
                
                <div id="logisticsBlock" class="d-none mt-3">
                    <h6 class="fw-bold mb-2 ps-1">–î–æ—Å—Ç–∞–≤–∫–∞</h6>
                    <div class="delivery-option selected" id="optStandard" onclick="selectDelivery('standard')">
                        <div><div class="fw-bold">–°—Ç–∞–Ω–¥–∞—Ä—Ç (–§—É—Ä–∞)</div><div class="small text-muted">–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è</div></div>
                        <i class="bi bi-check-circle-fill text-primary fs-5"></i>
                    </div>
                    <div class="delivery-option" id="optExpress" onclick="selectDelivery('express')">
                        <div><div class="fw-bold">–≠–∫—Å–ø—Ä–µ—Å—Å (–ü—è—Ç–∞–∫)</div><div class="small text-muted">–û–ø–ª–∞—Ç–∞ —Ç–∞–∫—Å–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</div></div>
                        <i class="bi bi-circle text-muted fs-5"></i>
                    </div>
                    <div class="bg-white p-3 rounded-3 border mt-2">
                        <div class="form-check form-switch d-flex justify-content-between ps-0 mb-0">
                            <label class="form-check-label fw-bold" for="switchDropship">üì¶ –î—Ä–æ–ø—à–∏–ø–ø–∏–Ω–≥</label>
                            <input class="form-check-input ms-auto" type="checkbox" id="switchDropship" onchange="toggleDropshipFields()">
                        </div>
                        <div id="dropshipFields" class="mt-3 d-none border-top pt-2">
                            <input type="text" id="dsName" class="form-control mb-2" placeholder="–§–ò–û –ö–ª–∏–µ–Ω—Ç–∞">
                            <input type="tel" id="dsPhone" class="form-control mb-2" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                            <textarea id="dsAddress" class="form-control" rows="2" placeholder="–ê–¥—Ä–µ—Å"></textarea>
                        </div>
                    </div>
                </div>

                <div id="cartFunnel" class="mt-3 bg-white p-3 rounded-3 border d-none">
                    <div class="d-flex justify-content-between small"><span>–¢–æ–≤–∞—Ä—ã:</span><span id="funnelBase">0</span></div>
                    <div class="d-flex justify-content-between small text-success"><span>–°–∫–∏–¥–∫–∞:</span><span id="funnelDiscount">0</span></div>
                    <div class="d-flex justify-content-between align-items-center mt-2 border-top pt-2">
                        <span class="small fw-bold">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (-2%)</span>
                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="cartPrepayCheck" onchange="updateCartFunnel()"></div>
                    </div>
                    <div class="text-center mt-3"><div class="small text-muted">–ò—Ç–æ–≥–æ</div><div class="fs-2 fw-bold text-primary" id="funnelFinal">0</div></div>
                </div>
            </div>
            <div class="modal-footer justify-content-center bg-white border-0"><button class="btn btn-primary w-100 py-3 rounded-3 fw-bold" onclick="submitOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const tg = window.Telegram.WebApp; tg.expand();
    const CONFIG = { batch: 24 };
    const FILE_DB = 'price.xlsx'; const FILE_REF = 'reference.xlsx';

    // === –ö–ê–¢–ï–ì–û–†–ò–ò –ò –ë–†–ï–ù–î–´ (–î–õ–Ø –°–û–†–¢–ò–†–û–í–ö–ò) ===
    const PRIORITY_CATS = ["–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã"];
    const PRIORITY_OFFICE_CATS = ["–°—Ç–µ–ø–ª–µ—Ä—ã, –∞–Ω—Ç–∏—Å—Ç–µ–ø–ª–µ—Ä—ã, —Å–∫–æ–±—ã", "–î—ã—Ä–æ–∫–æ–ª—ã", "–ù–æ–∂–Ω–∏—Ü—ã –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ –Ω–æ–∂–∏"];
    const PRIORITY_BRANDS = ["Linc", "–ì–ê–ú–ú–ê", "Claro", "Berlingo"];

    const DISCOUNT_PROFILES = {
        'new_partner': { tiers: [5, 10, 25], percents: [2, 3, 5] },
        'active': { tiers: [0], percents: [0] }
    };

    let state = { 
        db: [], filtered: [], cart: {}, loaded: 0, currentProduct: null, currentBoxSize: 1, sort: 'price_asc',
        mode: 'deli', activeCat1: 'all', activeCat2: 'all', activeSub: 'all', activeBrand: 'all',
        userId: 0, clientType: 'new_partner', deliveryMethod: 'standard'
    };
    let categoriesRef = {}; 

    document.addEventListener('DOMContentLoaded', () => {
        const p = new URLSearchParams(window.location.search);
        state.userId = p.get('userId') || 0;
        state.clientType = p.get('clientType') || 'new_partner';
        document.getElementById('userStatusChip').innerText = state.clientType;
        
        initDataLoading();
        
        let lastScrollTop = 0; const h = document.getElementById('mainHeader');
        window.addEventListener('scroll', () => {
            let st = window.pageYOffset || document.documentElement.scrollTop;
            if (st > lastScrollTop && st > 100) h.classList.add('hidden'); else h.classList.remove('hidden');
            lastScrollTop = st <= 0 ? 0 : st;
        });
        
        document.getElementById('searchInput').addEventListener('input', e => { setTimeout(filterData, 300); window.scrollTo({top:0,behavior:'smooth'}); });
        new IntersectionObserver(e => { if(e[0].isIntersecting) renderBatch(); }).observe(document.getElementById('scrollSentinel'));
    });

    async function initDataLoading() {
        document.getElementById('loaderOverlay').style.display = 'flex';
        try { await fetchReference(); await fetchDatabase(); } 
        catch(e) { console.error(e); loadLocalDB(); }
        document.getElementById('loaderOverlay').style.display = 'none';
    }

    async function fetchReference() {
        try {
            const r = await fetch(FILE_REF); if(!r.ok) throw new Error();
            const ab = await r.arrayBuffer(); const wb = XLSX.read(ab,{type:'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
            const ref = {};
            for(let i=1; i<json.length; i++) { if(json[i][4]) ref[json[i][4].toString().trim()] = {c1:json[i][1], c2:json[i][2], s:json[i][3]}; }
            categoriesRef = ref; localStorage.setItem('df_ref', JSON.stringify(ref));
        } catch(e) {}
    }

    async function fetchDatabase() {
        const r = await fetch(FILE_DB); if(!r.ok) throw new Error();
        const ab = await r.arrayBuffer(); const wb = XLSX.read(ab,{type:'array'});
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        
        let head=-1; for(let i=0; i<30; i++) if(JSON.stringify(json[i]||[]).toLowerCase().includes('–∞—Ä—Ç–∏–∫—É–ª')) { head=i; break; }
        if(head===-1) throw new Error();

        let cArt=0, cBr=1, cNm=2, cRet=4, cDeal=5, cPk=9;
        json[head].forEach((x,i) => {
            const s = String(x||'').toLowerCase();
            if(s.includes('–∞—Ä—Ç–∏–∫—É–ª')) cArt=i; else if(s.includes('–±—Ä–µ–Ω–¥')) cBr=i;
            else if(s.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ')) cNm=i; else if(s.includes('—Ä–æ–∑–Ω')) cRet=i;
            else if(s.includes('–¥–∏–ª–µ—Ä')) cDeal=i; else if(s.includes('—É–ø–∞–∫')) cPk=i;
        });

        const db = [];
        for(let i=head+1; i<json.length; i++) {
            const row = json[i];
            if(row && row[cArt]) {
                const art = row[cArt].toString().trim();
                const ref = categoriesRef[art] || {c1:'–î—Ä—É–≥–æ–µ', c2:'', s:''};
                const cln = v => parseFloat((v||0).toString().replace(/\s/g,'').replace(',','.'))||0;
                db.push({
                    id: art, br: row[cBr], nm: row[cNm],
                    pp: cln(row[cRet]), pd: cln(row[cDeal]), pk: row[cPk],
                    c1: ref.c1, c2: ref.c2, sub: ref.s
                });
            }
        }
        state.db = db; localStorage.setItem('df_db', JSON.stringify(db));
        if(db.length) { 
            state.activeCat1='–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã'; 
            state.activeCat2='–°—Ç–µ–ø–ª–µ—Ä—ã, –∞–Ω—Ç–∏—Å—Ç–µ–ø–ª–µ—Ä—ã, —Å–∫–æ–±—ã';
            renderModeRow(); filterData(); updateGlobalState(); 
        }
    }
    
    function loadLocalDB() {
        const d = localStorage.getItem('df_db');
        if(d) { state.db = JSON.parse(d); renderModeRow(); filterData(); updateGlobalState(); }
        else document.getElementById('emptyState').classList.remove('d-none');
    }

    // --- NAVIGATION RENDERERS (THE FIX) ---
    function renderModeRow() {
        const c = document.getElementById('rowMode'); c.innerHTML='';
        const add = (txt, val) => {
            const d = document.createElement('div'); d.className=`pill-mode ${state.mode===val?'active':''}`;
            d.innerText=txt; d.onclick=()=>{ setMode(val); }; c.appendChild(d);
        };
        add('Deli', 'deli'); add('Deskform', 'deskform');
        renderL2();
    }
    
    function setMode(m) {
        state.mode = m; state.activeCat1='all'; state.activeCat2='all'; state.activeSub='all'; state.activeBrand='all';
        if(m==='deli') { state.activeCat1='–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã'; state.activeCat2='–°—Ç–µ–ø–ª–µ—Ä—ã, –∞–Ω—Ç–∏—Å—Ç–µ–ø–ª–µ—Ä—ã, —Å–∫–æ–±—ã'; } else { state.activeBrand='Linc'; }
        renderModeRow(); filterData();
    }

    function renderL2() {
        const c = document.getElementById('rowL2'); c.innerHTML='';
        if(state.mode==='deli') {
            const u = {}; state.db.filter(x=>x.br==='Deli').forEach(x=>u[x.c1||'–î—Ä—É–≥–æ–µ']=1);
            let s = Object.keys(u).sort(); s=[...PRIORITY_CATS.filter(x=>s.includes(x)), ...s.filter(x=>!PRIORITY_CATS.includes(x))];
            s.forEach(k => { const d=document.createElement('div'); d.className=`pill-l1 ${state.activeCat1===k?'active':''}`; d.innerText=k; d.onclick=()=>{state.activeCat1=k; state.activeCat2='all'; state.activeSub='all'; renderL2(); filterData();}; c.appendChild(d); });
            renderL3();
        } else {
            const u = {}; state.db.filter(x=>x.br!=='Deli').forEach(x=>u[x.br]=1);
            let s = Object.keys(u).sort(); s=[...PRIORITY_BRANDS.filter(x=>s.includes(x)), ...s.filter(x=>!PRIORITY_BRANDS.includes(x))];
            s.forEach(k => { const d=document.createElement('div'); d.className=`pill-l1 ${state.activeBrand===k?'active':''}`; d.innerText=k; d.onclick=()=>{state.activeBrand=k; renderL2(); filterData();}; c.appendChild(d); });
            document.getElementById('rowL3').innerHTML=''; document.getElementById('rowL4').innerHTML='';
        }
    }

    function renderL3() {
        const c = document.getElementById('rowL3'); c.innerHTML='';
        if(state.activeCat1==='all') return;
        const u = {}; state.db.filter(x=>x.br==='Deli' && x.c1===state.activeCat1).forEach(x=>u[x.c2||'']=1);
        let s = Object.keys(u).sort(); 
        if(state.activeCat1.includes('–û—Ñ–∏—Å')) s=[...PRIORITY_OFFICE_CATS.filter(x=>s.includes(x)), ...s.filter(x=>!PRIORITY_OFFICE_CATS.includes(x))];
        s.forEach(k => { const d=document.createElement('div'); d.className=`pill-l2 ${state.activeCat2===k?'active':''}`; d.innerText=k; d.onclick=()=>{state.activeCat2=k; state.activeSub='all'; renderL3(); filterData();}; c.appendChild(d); });
        renderL4();
    }

    function renderL4() {
        const c = document.getElementById('rowL4'); c.innerHTML='';
        if(state.activeCat2==='all') return;
        const u = {}; state.db.filter(x=>x.br==='Deli' && x.c1===state.activeCat1 && x.c2===state.activeCat2).forEach(x=>u[x.sub||'']=1);
        const add = (k, l) => { const d=document.createElement('div'); d.className=`pill-l3 ${state.activeSub===k?'active':''}`; d.innerText=l; d.onclick=()=>{state.activeSub=k; filterData();}; c.appendChild(d); };
        add('all', '–í—Å–µ');
        Object.keys(u).sort().forEach(k => add(k, k));
    }

    function filterData() {
        const q = document.getElementById('searchInput').value.toLowerCase().trim();
        let list = state.db.filter(p => {
            if(q && !p.nm.toLowerCase().includes(q) && !p.id.toLowerCase().includes(q)) return false;
            if(state.mode==='deli') {
                if(p.br!=='Deli') return false;
                if(state.activeCat1!=='all' && p.c1!==state.activeCat1) return false;
                if(state.activeCat2!=='all' && p.c2!==state.activeCat2) return false;
                if(state.activeSub!=='all' && p.sub!==state.activeSub) return false;
            } else {
                if(p.br==='Deli') return false;
                if(state.activeBrand!=='all' && p.br!==state.activeBrand) return false;
            }
            return true;
        });
        if(state.sort==='price_asc') list.sort((a,b)=>a.pd - b.pd);
        state.filtered = list; document.getElementById('productsGrid').innerHTML=''; state.loaded=0; renderBatch();
    }

    function renderBatch() {
        const batch = state.filtered.slice(state.loaded, state.loaded+CONFIG.batch);
        const f = document.createDocumentFragment();
        batch.forEach(p => {
            const d = document.createElement('div'); d.className='col';
            const cnt = state.cart[p.id]||0;
            d.innerHTML = `<div class="product-card" onclick="openProduct('${p.id}')">
                <div class="chip-brand">${p.br}</div>
                <div class="img-wrapper"><img src="img/${p.id}.png" loading="lazy" onerror="this.src='https://dummyimage.com/200x200/eee/aaa&text=No+Img'">
                <div class="cart-indicator" style="display:${cnt?'flex':'none'}">${cnt}</div></div>
                <div class="card-info"><div class="card-title text-dark">${p.nm}</div>
                <div class="price-curr">${p.pd.toLocaleString()}</div></div></div>`;
            f.appendChild(d);
        });
        document.getElementById('productsGrid').appendChild(f); state.loaded+=batch.length;
        document.getElementById('emptyState').classList.toggle('d-none', state.filtered.length>0);
    }

    // --- CART ---
    function openProduct(id) {
        const p = state.db.find(x=>x.id===id); if(!p) return;
        state.currentProduct = p;
        document.getElementById('modalTitle').innerText = p.nm;
        document.getElementById('modalArt').innerText = p.id;
        document.getElementById('modalRetailPrice').innerText = p.pp>0?p.pp.toLocaleString():'---';
        document.getElementById('modalDealerPrice').innerText = p.pd.toLocaleString() + ' —Å—É–º';
        document.getElementById('modalImg').src = `img/${id}.png`;
        
        const nums = (p.pk||'').toString().match(/\d+/g);
        const maxBox = nums ? Math.max(...nums.map(Number)) : 1;
        state.currentBoxSize = maxBox;
        
        const box = document.getElementById('modeBox');
        if(maxBox>1) { box.disabled=false; document.getElementById('boxLabel').innerText=`x${maxBox}`; box.checked=true; }
        else { box.disabled=true; document.getElementById('boxLabel').innerText=''; document.getElementById('modeUnit').checked=true; }
        
        const cur = state.cart[p.id]||0;
        document.getElementById('qtyInput').value = (document.getElementById('modeBox').checked && maxBox>1) ? cur/maxBox : cur;
        updateCalc();
        new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    function updateCalc() {
        const p = state.currentProduct; if(!p) return;
        const box = document.getElementById('modeBox').checked;
        const qty = (parseInt(document.getElementById('qtyInput').value)||0) * (box ? state.currentBoxSize : 1);
        document.getElementById('calcTotalPrice').innerText = (qty * p.pd).toLocaleString();
    }
    function adjustQty(d) {
        const i = document.getElementById('qtyInput'); let v = (parseInt(i.value)||0)+d; if(v<0) v=0; i.value=v; updateCalc();
    }
    function confirmAddToCart() {
        const p = state.currentProduct; 
        const qty = (parseInt(document.getElementById('qtyInput').value)||0) * (document.getElementById('modeBox').checked ? state.currentBoxSize : 1);
        if(qty>0) state.cart[p.id]=qty; else delete state.cart[p.id];
        updateGlobalState(); bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
    }

    function updateGlobalState() {
        let sum = 0; Object.keys(state.cart).forEach(k => { const p=state.db.find(x=>x.id===k); if(p) sum+=p.pd*state.cart[k]; });
        document.getElementById('footerBaseSum').innerText = sum.toLocaleString();
        
        const count = Object.keys(state.cart).length;
        document.getElementById('cartCountBadge').innerText = count;
        document.getElementById('cartCountBadge').style.display = count?'inline-block':'none';
        updateCartFunnel();
    }

    function selectDelivery(m) {
        state.deliveryMethod = m;
        document.getElementById('optStandard').classList.remove('selected'); document.getElementById('optStandard').querySelector('.bi').className='bi bi-circle text-muted fs-5';
        document.getElementById('optExpress').classList.remove('selected'); document.getElementById('optExpress').querySelector('.bi').className='bi bi-circle text-muted fs-5';
        if(m==='standard') { document.getElementById('optStandard').classList.add('selected'); document.getElementById('optStandard').querySelector('.bi').className='bi bi-check-circle-fill text-primary fs-5'; }
        else { document.getElementById('optExpress').classList.add('selected'); document.getElementById('optExpress').querySelector('.bi').className='bi bi-check-circle-fill text-primary fs-5'; }
    }
    
    function toggleDropshipFields() {
        document.getElementById('dropshipFields').classList.toggle('d-none', !document.getElementById('switchDropship').checked);
    }

    function updateCartFunnel() {
        const list = document.getElementById('cartItemsList'); list.innerHTML='';
        const ids = Object.keys(state.cart);
        const logistics = document.getElementById('logisticsBlock');
        const funnel = document.getElementById('cartFunnel');
        const empty = document.getElementById('cartEmptyMsg');

        if(!ids.length) { empty.classList.remove('d-none'); logistics.classList.add('d-none'); funnel.classList.add('d-none'); return; }
        
        empty.classList.add('d-none'); logistics.classList.remove('d-none'); funnel.classList.remove('d-none');
        
        let sum = 0;
        ids.forEach((id, i) => {
            const p = state.db.find(x=>x.id===id); const q = state.cart[id]; const tot = p.pd*q; sum+=tot;
            list.innerHTML += `<div class="cart-item"><div class="fw-bold small">${i+1}. ${p.nm}</div><div class="d-flex justify-content-between"><div>${q} —à—Ç x ${p.pd}</div><div class="fw-bold">${tot.toLocaleString()}</div></div></div>`;
        });

        const prof = DISCOUNT_PROFILES[state.clientType] || DISCOUNT_PROFILES['new_partner'];
        let tierPct = 0; 
        if(prof.tiers[0] !== 0) {
            const m = sum/1000000;
            for(let i=0; i<prof.tiers.length; i++) { if(m>=prof.tiers[i]) tierPct=prof.percents[i]; else break; }
        }
        const afterTier = sum - (sum*tierPct/100);
        const prepay = document.getElementById('cartPrepayCheck').checked;
        const final = afterTier - (afterTier * (prepay?0.02:0));

        document.getElementById('funnelBase').innerText = sum.toLocaleString();
        document.getElementById('funnelDiscount').innerText = `-${tierPct}%`;
        document.getElementById('funnelFinal').innerText = Math.round(final).toLocaleString() + ' —Å—É–º';
    }

    function submitOrder() {
        if(!Object.keys(state.cart).length) return;
        const isDrop = document.getElementById('switchDropship').checked;
        let rcp = null;
        if(isDrop) {
            const n=document.getElementById('dsName').value, p=document.getElementById('dsPhone').value, a=document.getElementById('dsAddress').value;
            if(!n||!p||!a) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è!"); return; }
            rcp = {name:n, phone:p, address:a};
        }

        let base = 0; const items = [];
        Object.keys(state.cart).forEach(k => {
            const p = state.db.find(x=>x.id===k);
            base += p.pd*state.cart[k];
            items.push({ product_id:k, name:p.nm, qty:state.cart[k], price_per_unit:p.pd, total:p.pd*state.cart[k] });
        });

        const prepay = document.getElementById('cartPrepayCheck').checked;
        
        // RECALC FINAL
        const prof = DISCOUNT_PROFILES[state.clientType] || DISCOUNT_PROFILES['new_partner'];
        let tierPct = 0; 
        if(prof.tiers[0] !== 0) {
            const m = base/1000000;
            for(let i=0; i<prof.tiers.length; i++) { if(m>=prof.tiers[i]) tierPct=prof.percents[i]; else break; }
        }
        const final = (base - (base*tierPct/100)) * (prepay?0.98:1);

        const data = {
            userId: state.userId, clientType: state.clientType,
            items: items, total_base: base, total_final: Math.round(final),
            discount_tier_pct: tierPct, discount_pay_pct: prepay?2:0,
            is_prepay: prepay,
            delivery_type: isDrop ? 'dropshipping' : 'standard',
            shipping_method: state.deliveryMethod,
            recipient_info: rcp
        };
        try { tg.sendData(JSON.stringify(data)); } catch(e) { alert("Sent!"); }
    }
</script>
</body>
</html>
