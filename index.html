<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Deskform App | v3.2 Custom Files</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS Styles remain standard */
        :root { 
            --primary: #007aff; 
            --bg: #f2f2f7; 
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sec: #6B7280;
            --retail: #9CA3AF;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --header-blur: rgba(255, 255, 255, 0.98);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 160px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER */
        .header-wrapper { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: var(--header-blur); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); will-change: transform; }
        .header-wrapper.hidden { transform: translateY(-100%); }
        .navbar { padding: 8px 0; }
        .navbar-brand { font-weight: 800; color: var(--text-main) !important; font-size: 1.1rem; line-height: 1; cursor: pointer; }
        .brand-chip { background: rgba(255, 204, 0, 0.15); color: #9A7B0C; border: 1px solid rgba(255, 204, 0, 0.2); font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; font-weight: 700; align-self: flex-start; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        
        /* SCROLLS */
        .cat-scroll-container { display: flex; flex-direction: column; gap: 8px; padding-bottom: 8px; }
        .scroll-row { overflow-x: auto; white-space: nowrap; padding: 0 4px; -ms-overflow-style: none; scrollbar-width: none; display: flex; gap: 8px; cursor: grab; opacity: 0; transform: translateY(-10px); height: 0; pointer-events: none; margin-bottom: 0; transition: all 0.25s ease-out; user-select: none; }
        .scroll-row:active { cursor: grabbing; }
        .scroll-row::-webkit-scrollbar { display: none; }
        #rowMode { opacity: 1; transform: translateY(0); height: auto; pointer-events: auto; }
        .scroll-row.visible { opacity: 1; transform: translateY(0); height: auto; pointer-events: auto; }
        .cnt { font-size: 0.75em; opacity: 0.6; margin-left: 4px; font-weight: 400; }
        .active .cnt { opacity: 0.9; color: white; }

        /* CHIPS */
        .pill-mode { padding: 10px 20px; background: #fff; color: var(--text-main); border-radius: 24px; font-size: 1rem; font-weight: 800; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.04); transition: all 0.2s; cursor: pointer; display: flex; align-items: center; }
        .pill-mode.active { background: #111827; color: white; border-color: #111827; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .pill-l1 { padding: 8px 16px; background: #fff; color: var(--text-main); border-radius: 20px; font-size: 0.9rem; font-weight: 700; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 6px rgba(0,0,0,0.03); transition: all 0.2s; cursor: pointer; display: flex; align-items: center; }
        .pill-l1.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .pill-l2 { padding: 6px 14px; background: #E0F2FE; color: #0369A1; border-radius: 16px; font-size: 0.85rem; font-weight: 600; border: 1px solid transparent; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; }
        .pill-l2.active { background: #0284C7; color: white; box-shadow: 0 2px 8px rgba(2, 132, 199, 0.3); }
        .pill-l3 { padding: 5px 12px; background: #F3F4F6; color: var(--text-sec); border-radius: 12px; font-size: 0.75rem; font-weight: 500; border: 1px solid rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer; display: flex; align-items: center; }
        .pill-l3.active { background: var(--accent-green); color: white; border-color: var(--accent-green); }

        .search-input-group { border-radius: 12px; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); }
        .search-input-group input { border: none; font-size: 16px; padding: 12px; }
        .container-main { padding-top: 260px; transition: padding-top 0.3s ease-out; }

        /* CARDS */
        .product-card { background: var(--card-bg); border: none; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); height: 100%; display: flex; flex-direction: column; overflow: hidden; cursor: pointer; position: relative; transition: transform 0.1s; }
        .product-card:active { transform: scale(0.98); }
        .img-wrapper { height: 190px; padding: 20px; display: flex; align-items: center; justify-content: center; background: white; position: relative; }
        .img-wrapper img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .chip-brand { position: absolute; top: 10px; left: 10px; background: #F3F4F6; color: var(--text-main); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; z-index: 9; }
        .chip-pack { position: absolute; top: 10px; right: 10px; background: #F3F4F6; color: var(--text-sec); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; z-index: 9; }
        .cart-indicator { position: absolute; bottom: 10px; right: 10px; background: var(--primary); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(0,122,255,0.4); z-index: 20; }
        .card-info { padding: 14px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-title-text { font-size: 0.95rem; font-weight: 500; line-height: 1.3; margin-bottom: 4px; height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price-row { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; }
        .price-col { display: flex; flex-direction: column; }
        .price-retail-label { font-size: 0.7rem; color: var(--retail); display: block; margin-bottom: 2px; }
        .price-curr { font-size: 1.15rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; line-height: 1; }
        .badge-promo { background: var(--accent-red); color: white; padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; white-space: nowrap; margin-left: 8px; margin-bottom: 2px; }
        .badge-green { background-color: var(--accent-green) !important; }

        /* FOOTER & MODALS */
        .bottom-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid rgba(0,0,0,0.08); z-index: 990; padding-bottom: env(safe-area-inset-bottom); transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); will-change: transform; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .bottom-panel.hidden { transform: translateY(100%); }
        .footer-fill-bg { position: absolute; top: 0; left: 0; bottom: 0; background: rgba(16, 185, 129, 0.15); z-index: 0; width: 0%; transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1); border-right: 1px solid rgba(16, 185, 129, 0.3); }
        .footer-grid { position: relative; z-index: 1; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 10px 16px 15px 16px; }
        .footer-center { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .f-game-text { font-size: 0.7rem; font-weight: 600; color: var(--primary); margin-bottom: 2px; white-space: nowrap; }
        .f-label-main { font-size: 0.7rem; color: var(--text-sec); line-height: 1.2; }
        .f-val-main { font-size: 1rem; font-weight: 800; color: var(--text-main); }
        .f-benefit { font-size: 0.8rem; color: var(--accent-green); font-weight: 700; margin-top: 2px; }
        .btn-order { background: rgba(0, 122, 255, 0.1); color: var(--primary); border: 1px solid rgba(0, 122, 255, 0.2); border-radius: 14px; padding: 10px 20px; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; justify-self: end; backdrop-filter: blur(5px); transition: all 0.2s; }
        .cart-count-badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 6px; font-size: 0.75rem; }
        .level-up-toast { position: fixed; top: 180px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #10B981; color: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4); font-weight: 700; font-size: 0.9rem; z-index: 2000; opacity: 0; pointer-events: none; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 8px; }
        .level-up-toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .modal-content { border-radius: 24px; border: none; }
        .modal-product-img { height: 240px; display: flex; align-items: center; justify-content: center; background: #fff; margin-bottom: 15px; border-radius: 16px; padding: 10px; }
        .modal-product-img img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .quantity-control { background: #fff; border: 1px solid rgba(0,0,0,0.05); border-radius: 16px; padding: 20px; margin-top: 15px; position: relative; }
        .mode-switch .btn { border: none; border-radius: 12px; color: var(--text-sec); font-weight: 500; padding: 6px 16px; }
        .mode-switch .btn-check:checked + .btn { background-color: #F3F4F6; color: var(--text-main); font-weight: 700; }
        .big-input { border: 1px solid transparent; background: transparent; font-size: 2rem; font-weight: 700; text-align: center; height: 60px; color: var(--text-main); border-radius: 12px; }
        .big-input:focus { background: #f2f2f7; outline: none; }
        .btn-qty { border: 1px solid #e5e5ea; border-radius: 12px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem; background: white; }
        
        .cart-item { background: white; border-radius: 16px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .cart-item-head { display: flex; align-items: flex-start; margin-bottom: 12px; }
        .cart-index { color: var(--text-sec); font-size: 0.8rem; margin-right: 6px; font-weight: 700; margin-top: 2px; }
        .cart-item-title { font-weight: 600; font-size: 0.95rem; line-height: 1.3; color: var(--text-main); white-space: normal; }
        .cart-item-body { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .qty-wrapper { display: flex; align-items: center; }
        .qty-label { font-size: 0.75rem; color: var(--text-sec); margin-right: 8px; font-weight: 500; }
        .cart-controls { display: flex; align-items: center; background: #F3F4F6; border-radius: 10px; padding: 2px; }
        .ctrl-btn { width: 32px; height: 32px; border: none; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ctrl-val { width: 36px; text-align: center; font-weight: 700; font-size: 0.95rem; }
        .price-per-unit { font-size: 0.75rem; color: var(--text-sec); margin-left: 8px; }
        .cart-item-total { margin-left: auto; text-align: right; }
        .total-price-val { font-weight: 800; font-size: 1.1rem; color: var(--text-main); }
        .del-btn { width: 32px; height: 32px; border: none; background: #FEF2F2; color: var(--accent-red); border-radius: 8px; margin-left: 10px; display: flex; align-items: center; justify-content: center; }
        
        .funnel-container { margin-top: 20px; background: #fff; border-radius: 16px; padding: 15px; border: 1px solid rgba(0,0,0,0.05); }
        .funnel-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 6px; border-radius: 10px; font-size: 12px; }
        .f-step-1 { background: var(--funnel-1); width: 100%; }
        .f-chip { font-weight: 700; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 6px; }
        .f-chip.green { background-color: rgba(16, 185, 129, 0.1); color: #10B981; }
        .f-chip.gray { background-color: #F3F4F6; color: #6B7280; }
        .final-block { margin-top: 15px; text-align: center; border-top: 1px dashed #e5e5ea; padding-top: 15px; }
        .final-price { font-size: 24px; font-weight: 800; color: var(--accent-green); }

        #loaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .calc-bar-bg { width: 100%; height: 8px; background: #e5e5ea; border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .calc-bar-fill { height: 100%; transition: width 0.4s ease; border-radius: 4px; }
        .ios-slider { -webkit-appearance: none; width: 100%; height: 6px; background: #e5e5ea; border-radius: 3px; }
        .ios-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; background: #ffffff; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    </style>
</head>
<body>

<div id="loaderOverlay">
    <div class="spinner-border text-primary mb-3"></div>
    <div class="fw-bold text-secondary">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div id="toastContainer"></div>

<div class="header-wrapper" id="mainHeader">
    <div class="container">
        <nav class="navbar d-flex align-items-center justify-content-between">
            <div class="brand-col">
                <span class="navbar-brand">Deskform Dealer</span>
                <span class="brand-chip" id="userStatusChip">–°—Ç–∞—Ç—É—Å: –ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="openCalculator()">
                    <i class="bi bi-calculator"></i>
                </button>
                <button class="btn btn-sm btn-light rounded-pill px-3" onclick="resetFilters()">–°–±—Ä–æ—Å</button>
            </div>
        </nav>
        
        <div class="search-container-inner">
            <div class="row g-2">
                <div class="col-12">
                    <div class="input-group search-input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
                    </div>
                </div>
                <div class="col-12">
                     <div class="cat-scroll-container">
                         <div id="rowMode" class="scroll-row"></div>
                         <div id="rowL2" class="scroll-row"></div>
                         <div id="rowL3" class="scroll-row"></div>
                         <div id="rowL4" class="scroll-row"></div>
                     </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container container-main">
    <div id="productsGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3"></div>
    <div id="scrollSentinel" class="text-center py-4 opacity-0"><div class="spinner-grow spinner-grow-sm text-secondary"></div></div>

    <div id="emptyState" class="text-center py-5 d-none">
        <i class="bi bi-search display-1 text-muted opacity-25"></i>
        <p class="mt-2 text-muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
    </div>
    <div id="noDbState" class="text-center py-5 d-none">
        <h4 class="mt-3">–ë–∞–∑–∞ –ø—É—Å—Ç–∞</h4>
        <p class="text-muted small">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Ö –∏–º–µ–Ω–∞ –Ω–∞ GitHub.</p>
    </div>
</div>

<div class="bottom-panel" id="mainFooter">
    <div class="footer-fill-bg" id="footerFill"></div>
    <div class="footer-grid">
        <div></div> 
        <div class="footer-center">
            <div class="f-game-text" id="footerGameText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div><span class="f-label-main">–¢–æ–≤–∞—Ä–æ–≤ –Ω–∞:</span> <span class="f-val-main" id="footerBaseSum">0</span></div>
            <div class="f-benefit">–í—ã–≥–æ–¥–∞: <span id="footerBenefit">0</span></div>
        </div>
        <button class="btn-order" data-bs-toggle="modal" data-bs-target="#cartModal">
            –ó–∞–∫–∞–∑ <span class="cart-count-badge" id="cartCountBadge" style="display:none">0</span>
        </button>
    </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button><div class="modal-product-img"><img id="modalImg" src="" alt="" data-id=""></div><h5 class="fw-bold mb-1" id="modalTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</h5><div class="text-muted small mb-3">–ê—Ä—Ç–∏–∫—É–ª: <span id="modalArt" class="fw-bold text-dark"></span></div><div class="d-flex justify-content-between align-items-center mb-1"><span class="text-muted small">–¶–µ–Ω–∞ –≤ –¢–∞—à–∫–µ–Ω—Ç–µ:</span><span class="text-decoration-line-through text-muted" id="modalRetailPrice">0 —Å—É–º</span></div><div class="d-flex justify-content-between align-items-center mb-2"><span class="fw-bold">–í–∞—à–∞ —Ü–µ–Ω–∞:</span><span class="fs-3 fw-bold" style="color:var(--primary)" id="modalDealerPrice">0 —Å—É–º</span></div><div class="quantity-control"><div class="d-flex justify-content-center mb-3 mt-2"><div class="btn-group mode-switch" role="group"><input type="radio" class="btn-check" name="qtyMode" id="modeUnit" onchange="updateCalc()"><label class="btn" for="modeUnit">–®—Ç—É–∫–∏</label><input type="radio" class="btn-check" name="qtyMode" id="modeBox" onchange="updateCalc()"><label class="btn" for="modeBox">–ö–æ—Ä–æ–±–∫–∞ <span id="boxLabel" class="badge bg-secondary ms-1" style="font-weight:400"></span></label></div></div><div class="d-flex align-items-center justify-content-between mt-3"><div class="btn-qty" onclick="adjustQty(-1)"><i class="bi bi-dash"></i></div><input type="number" id="qtyInput" class="big-input mx-2" style="width: 100px" value="0" min="0" oninput="updateCalc()" onfocus="this.select()"><div class="btn-qty" onclick="adjustQty(1)"><i class="bi bi-plus"></i></div></div><div class="text-center text-muted small mt-2">–°—É–º–º–∞: <span id="calcTotalPrice" class="fw-bold text-dark">0</span> —Å—É–º</div></div><button class="btn btn-primary w-100 py-3 mt-3 rounded-4 fw-bold fs-6" onclick="confirmAddToCart()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–∫–∞–∑</button></div></div></div></div>
<div class="modal fade" id="cartModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content" style="background: #f9fafb;"><div class="modal-header border-0"><h5 class="modal-title fw-bold ms-2">–í–∞—à –∑–∞–∫–∞–∑</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-3 pt-0"><div id="cartItemsList"></div><div id="cartEmptyMsg" class="text-center py-5 text-muted">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div><div id="cartFunnel" class="funnel-container d-none"><div class="text-center fw-bold mb-3 small text-uppercase text-muted">–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</div><div class="funnel-row f-step-1"><span class="f-label">–†–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞</span><span class="f-val" id="funnelRetail">0</span></div><div class="funnel-row f-step-2"><span class="f-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–∏–ª–µ—Ä–∞</span><div><span class="f-chip green">-15%</span><span class="f-val" id="funnelBase">0</span></div></div><div class="funnel-row f-step-3"><span class="f-label">–û–±—ä–µ–º –∑–∞–∫—É–ø–∞ <span id="volLabel" class="text-muted small fw-normal"></span></span><div><span class="f-chip gray" id="chipVolPct">0%</span><span class="f-val" id="funnelVol">0</span></div></div><div class="funnel-row f-step-4"><span class="f-label">–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã</span><div><div class="d-flex justify-content-end mb-1"><div class="form-check form-switch me-2"><input class="form-check-input" type="checkbox" id="cartPromoCheck" onchange="updateCartFunnel()"><label class="form-check-label small" for="cartPromoCheck">–ê–∫—Ü–∏—è</label></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="cartPrepayCheck" onchange="updateCartFunnel()"><label class="form-check-label small" for="cartPrepayCheck">–ü—Ä–µ–¥–æ–ø–ª.</label></div></div><div class="text-end"><span class="f-chip gray" id="chipPayPct">0%</span></div></div></div><div class="final-block"><span class="text-muted small">–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞</span><div class="final-price" id="funnelFinal">0 —Å—É–º</div></div></div></div><div class="modal-footer justify-content-center bg-white border-top-0 rounded-bottom-4"><button class="btn btn-primary rounded-pill px-5 py-3 fw-bold w-100" onclick="submitOrder()"><i class="bi bi-check-circle-fill me-2"></i>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button></div></div></div></div>
<div class="modal fade" id="calcModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body px-4 pb-4 pt-4"><button type="button" class="btn-close position-absolute end-0 top-0 m-3" data-bs-dismiss="modal"></button><div class="mb-4"><label class="text-muted small text-uppercase fw-bold mb-2">–°—É–º–º–∞ –∑–∞–∫—É–ø–∞</label><div class="fw-bold fs-1 text-center mb-1" id="calcAmountDisplay">50 –º–ª–Ω</div><input type="range" class="ios-slider" id="calcAmountSlider" min="5" max="200" step="1" value="50"><div class="d-flex justify-content-between text-muted" style="font-size: 0.7rem;"><span>5 –º–ª–Ω</span><span>200+ –º–ª–Ω</span></div></div><div class="bg-light p-3 rounded-4 d-flex justify-content-between align-items-center mb-4"><div><div class="fw-bold">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</div><div class="text-muted small">–ë–æ–Ω—É—Å +2% –∫ —Å–∫–∏–¥–∫–µ</div></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="calcPrepayCheck" checked style="width: 50px; height: 26px;"></div></div><div class="bg-light p-3 rounded-4"><div class="text-center mb-3"><small class="text-muted text-uppercase fw-bold">–í–∞—à–∞ —ç–∫–æ–Ω–æ–º–∏—è</small><div class="fw-bold fs-1 text-success" id="calcTotalBenefit">0</div><div class="text-muted small" id="calcTotalPercent">—Å–∫–∏–¥–∫–∞ 0%</div></div><div class="row g-2"><div class="col-12"><div class="d-flex justify-content-between small mb-1"><span>–°–∫–∏–¥–∫–∞ –æ—Ç –æ–±—ä–µ–º–∞</span> <span id="calcBaseLabel">0%</span></div><div class="calc-bar-bg"><div id="calcBaseBar" class="calc-bar-fill" style="background-color: var(--primary); width:0%"></div></div></div><div class="col-12 mt-3"><div class="d-flex justify-content-between small mb-1"><span>–ê–∫—Ü–∏—è</span> <span>+4%</span></div><div class="calc-bar-bg"><div class="calc-bar-fill" style="background-color: var(--accent-purple); width:100%"></div></div></div><div class="col-12 mt-3" id="calcPrepayRow"><div class="d-flex justify-content-between small mb-1"><span>–ó–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É</span> <span>+2%</span></div><div class="calc-bar-bg"><div id="calcPrepayBar" class="calc-bar-fill" style="background-color: var(--accent-green); width:100%"></div></div></div></div></div><div class="d-flex justify-content-between align-items-end mt-4 pt-3 border-top"><span class="text-muted">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span><span class="fs-3 fw-bold" id="calcFinalPrice">0 –º–ª–Ω</span></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const CONFIG = { batch: 24 };
    const PRIORITY_CATS = ["–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã"];
    const PRIORITY_BRANDS = ["Linc", "–ì–ê–ú–ú–ê", "Claro", "Berlingo", "ALTA", "COLOP", "BG", "Svetocopy", "–°–Ω–µ–≥—É—Ä–æ—á–∫–∞"];
    const PRIORITY_OFFICE_CATS = [ "–°—Ç–µ–ø–ª–µ—Ä—ã, –∞–Ω—Ç–∏—Å—Ç–µ–ø–ª–µ—Ä—ã, —Å–∫–æ–±—ã", "–î—ã—Ä–æ–∫–æ–ª—ã", "–ù–æ–∂–Ω–∏—Ü—ã –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ –Ω–æ–∂–∏", "–î–æ—Å–∫–∏", "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã", "–û—Ä–≥–∞–Ω–∞–π–∑–µ—Ä—ã, –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –∏ –ª–æ—Ç–∫–∏", "–ü–æ–¥—Å—Ç–∞–≤–∫–∏ –∏ —Å—Ç–∞–∫–∞–Ω—ã", "–ó–∞–∂–∏–º—ã" ];

    // === –í–ê–ñ–ù–û: –ò–ú–ï–ù–ê –§–ê–ô–õ–û–í ===
    const FILE_DB = '–ü—Ä–∞–π—Å_–ª–∏—Å—Ç_DeskForm_2025_12_10_–ó–ê–ö–ê–ó_–¥–∏–ª–µ—Ä+.xlsx';
    const FILE_REF = '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π Deli.xlsx';

    const DISCOUNT_PROFILES = {
        'new': { name: "–ù–æ–≤—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä", tiers: [5, 10, 25, 50, 100, 150], percents: [2, 3, 5, 7, 9, 11] },
        'active_dealer': { name: "–î–µ–π—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Ç–Ω–µ—Ä", tiers: [5, 10, 25, 50, 100, 150], percents: [3, 4, 6, 8, 10, 12] },
        'market_solnechny': { name: "–†—ã–Ω–æ–∫ –°–æ–ª–Ω–µ—á–Ω—ã–π", tiers: [10, 50], percents: [5, 10] },
        'market_urikzar': { name: "–†—ã–Ω–æ–∫ –£—Ä–∏–∫–∑–∞—Ä", tiers: [10, 100], percents: [6, 11] }
    };

    let state = { 
        db: [], filtered: [], cart: {}, loaded: 0, currentProduct: null, currentBoxSize: 1, sort: 'price_asc',
        mode: 'deli', activeCat1: 'all', activeCat2: 'all', activeSub: 'all', activeBrand: 'all',
        userId: 0, clientType: 'new', currentProfile: DISCOUNT_PROFILES['new']
    };
    let lastTierPct = 0; let categoriesRef = {}; 

    document.addEventListener('DOMContentLoaded', () => {
        initWebAppParams();
        initDataLoading();
        let lastScrollTop = 0; const header = document.getElementById('mainHeader'); const footer = document.getElementById('mainFooter');
        window.addEventListener('scroll', () => {
            requestAnimationFrame(() => {
                let st = window.pageYOffset || document.documentElement.scrollTop;
                if (st > lastScrollTop && st > 100) { header.classList.add('hidden'); footer.classList.remove('hidden'); } else if (st < lastScrollTop) { header.classList.remove('hidden'); footer.classList.add('hidden'); } lastScrollTop = st <= 0 ? 0 : st;
            });
        });
        document.getElementById('searchInput').addEventListener('input', e => { setTimeout(() => filterData(), 300); window.scrollTo({ top: 0, behavior: 'smooth' }); });
        const sentinel = document.getElementById('scrollSentinel');
        new IntersectionObserver(entries => { if(entries[0].isIntersecting && state.loaded < state.filtered.length) renderBatch(); }, { rootMargin: '400px' }).observe(sentinel);
        initCalculator();
        initDragScroll(); 
    });

    function initWebAppParams() {
        const urlParams = new URLSearchParams(window.location.search);
        state.userId = urlParams.get('userId') || tg.initDataUnsafe?.user?.id || 0;
        const typeParam = urlParams.get('clientType') || 'new';
        if (DISCOUNT_PROFILES[typeParam]) { state.clientType = typeParam; state.currentProfile = DISCOUNT_PROFILES[typeParam]; }
        document.getElementById('userStatusChip').textContent = `–°—Ç–∞—Ç—É—Å: ${state.currentProfile.name}`;
    }

    async function initDataLoading() {
        document.getElementById('footerGameText').innerText = "1/2 –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...";
        try {
            await fetchReference();
            document.getElementById('footerGameText').innerText = "2/2 –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...";
            await fetchDatabase();
            document.getElementById('footerGameText').innerText = "–ì–æ—Ç–æ–≤–æ!";
        } catch (e) {
            console.error("Critical Load Error:", e);
            document.getElementById('footerGameText').innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
            loadLocalDB();
        }
    }

    async function fetchReference() {
        try {
            const response = await fetch(FILE_REF);
            if (!response.ok) throw new Error("–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");
            const arrayBuffer = await response.arrayBuffer();
            const wb = XLSX.read(arrayBuffer, {type:'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, {header:1});
            const newRef = {};
            for(let i=1; i<json.length; i++) {
                const r = json[i];
                if(r && r[4]) { const art = r[4].toString().trim(); newRef[art] = { c1: r[1], c2: r[2], s: r[3] }; }
            }
            categoriesRef = newRef;
            localStorage.setItem('df_ref', JSON.stringify(categoriesRef));
        } catch (e) {
            console.warn("Using cached Ref:", e);
            const cached = localStorage.getItem('df_ref');
            if(cached) categoriesRef = JSON.parse(cached);
        }
    }

    async function fetchDatabase() {
        const response = await fetch(FILE_DB);
        if (!response.ok) throw new Error("–ë–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
        const arrayBuffer = await response.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {header:1});
        let head = -1; 
        for(let i=0; i<50; i++) if(JSON.stringify(json[i]||[]).toLowerCase().includes('–∞—Ä—Ç–∏–∫—É–ª')) { head=i; break; }
        if(head === -1) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –±–∞–∑—ã");
        const db = [];
        for(let i=head+1; i<json.length; i++) {
            const r = json[i];
            if(r && r[0]) {
                const clean = v => parseFloat((v||0).toString().replace(/\s/g,'').replace(',','.')) || 0;
                const art = r[0].toString().trim();
                const ref = categoriesRef[art] || {c1: '–î—Ä—É–≥–æ–µ', c2: '', s: ''};
                db.push({ id: art, br:r[1], nm:r[2], pp:clean(r[4]), pd:clean(r[5]), ps:clean(r[8]), pr:r[6], pk:r[9], c1: ref.c1, c2: ref.c2, sub: ref.s });
            }
        }
        if (db.length > 0) {
            state.db = db;
            localStorage.setItem('df_db', JSON.stringify(db));
            document.getElementById('noDbState').classList.add('d-none');
            const uniqueCats = new Set(state.db.map(p => p.c1));
            if (uniqueCats.size <= 1) state.db.forEach(p => p.c1 = p.br);
            state.mode = 'deli'; state.activeCat1 = '–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã'; state.activeCat2 = '–°—Ç–µ–ø–ª–µ—Ä—ã, –∞–Ω—Ç–∏—Å—Ç–µ–ø–ª–µ—Ä—ã, —Å–∫–æ–±—ã'; state.activeSub = 'all';
            renderModeRow(); filterData(); updateGlobalState();
        }
    }

    function loadLocalDB() {
        const raw = localStorage.getItem('df_db');
        const rawRef = localStorage.getItem('df_ref');
        if(rawRef) categoriesRef = JSON.parse(rawRef);
        if(raw) { 
            state.db = JSON.parse(raw); 
            document.getElementById('noDbState').classList.add('d-none'); 
            renderModeRow(); filterData(); updateGlobalState(); 
        } else document.getElementById('noDbState').classList.remove('d-none');
    }

    // Logic Functions (DiscountSystem, Render, Cart, etc. remain unchanged)
    // ... (For brevity, standard logic follows below)
    const DiscountSystem={getTierPercent:function(e){const t=state.currentProfile.tiers,n=state.currentProfile.percents;let a=e/1e6,r=0;for(let e=0;e<t.length;e++)if(a>=t[e])r=n[e];else break;return a>=t[t.length-1]&&(r=n[n.length-1]),r},getRangeInfo:function(e){const t=state.currentProfile.tiers,n=state.currentProfile.percents;let a=e/1e6,r=0,l=t[0],c=n[0];for(let e=0;e<t.length;e++)if(a>=t[e]){if(r=t[e],e+1<t.length){l=t[e+1],c=n[e+1]}else l=t[e],c=n[e]}else{l=t[e],c=n[e];break}return{prevLimit:1e6*r,nextLimit:1e6*l,nextPct:c,isMax:a>=t[t.length-1]}},calculate:function(e,t,n){const a=this.getTierPercent(e),r=e-e*(a/100);let l=0;n&&(l+=4),t&&(l+=2);const c=r-r*(l/100),o=e/.85,s=o-c;return{baseSum:e,tierPct:a,sumAfterTier:r,payPct:l,finalSum:c,totalBenefit:s}}};
    function renderModeRow(){const e=document.getElementById("rowMode");e.innerHTML="";const t=document.createElement("div");t.className=`pill-mode ${"deli"===state.mode?"active":""}`,t.textContent="Deli",t.onclick=()=>setMode("deli"),e.appendChild(t);const n=document.createElement("div");n.className=`pill-mode ${"deskform"===state.mode?"active":""}`,n.textContent="–ê—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç Deskform",n.onclick=()=>setMode("deskform"),e.appendChild(n),renderLevel2(),setTimeout((()=>{const e=document.getElementById("mainHeader").offsetHeight;document.querySelector(".container-main").style.paddingTop=e+16+"px"}),50)}function setMode(e){state.mode=e,state.activeCat1="all",state.activeCat2="all",state.activeSub="all",state.activeBrand="all","deli"===e?(state.activeCat1="–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã",state.activeCat2="–°—Ç–µ–ø–ª–µ—Ä—ã, –∞–Ω—Ç–∏—Å—Ç–µ–ø–ª–µ—Ä—ã, —Å–∫–æ–±—ã"):state.activeBrand="Linc",renderModeRow(),filterData(),window.scrollTo({top:0,behavior:"smooth"})}function renderLevel2(){const e=document.getElementById("rowL2");if(e.innerHTML="",e.classList.add("visible"),"deli"===state.mode){const t={};state.db.filter((e=>"Deli"===e.br)).forEach((e=>{const n=e.c1||"–î—Ä—É–≥–æ–µ";"–î—Ä—É–≥–æ–µ"!==n&&(t[n]=(t[n]||0)+1)}));let n=Object.keys(t).sort();n=[...PRIORITY_CATS.filter((e=>n.includes(e))),...n.filter((e=>!PRIORITY_CATS.includes(e)))],n.forEach((n=>{const a=document.createElement("div");a.className=`pill-l1 ${state.activeCat1===n?"active":""}`,a.innerHTML=`${n} <span class="cnt">${t[n]}</span>`,a.onclick=()=>selectCat1(n),e.appendChild(a)})),renderLevel3Deli()}else{const t={};state.db.filter((e=>"Deli"!==e.br)).forEach((e=>{t[e.br]=(t[e.br]||0)+1}));let n=Object.keys(t).sort();n=[...PRIORITY_BRANDS.filter((e=>n.includes(e))),...n.filter((e=>!PRIORITY_BRANDS.includes(e)))],n.forEach((n=>{const a=document.createElement("div");a.className=`pill-l1 ${state.activeBrand===n?"active":""}`,a.innerHTML=`${n} <span class="cnt">${t[n]}</span>`,a.onclick=()=>selectBrand(n),e.appendChild(a)})),document.getElementById("rowL3").classList.remove("visible"),document.getElementById("rowL4").classList.remove("visible")}}function renderLevel3Deli(){const e=document.getElementById("rowL3");if("all"===state.activeCat1)return void e.classList.remove("visible");const t={};if(state.db.filter((e=>"Deli"===e.br&&e.c1===state.activeCat1)).forEach((e=>{e.c2&&(t[e.c2]=(t[e.c2]||0)+1)})),0===Object.keys(t).length)return void e.classList.remove("visible");e.classList.add("visible"),e.innerHTML="";let n=Object.keys(t).sort();if("–û—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–µ–ª–æ–≤—ã–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã"===state.activeCat1){const e=PRIORITY_OFFICE_CATS.filter((e=>n.includes(e))),t=n.filter((e=>!PRIORITY_OFFICE_CATS.includes(e)));n=[...e,...t]}n.forEach((n=>{const a=document.createElement("div");a.className=`pill-l2 ${state.activeCat2===n?"active":""}`,a.innerHTML=`${n} <span class="cnt">${t[n]}</span>`,a.onclick=()=>selectCat2(n),e.appendChild(a)})),renderLevel4Deli()}function renderLevel4Deli(){const e=document.getElementById("rowL4");if("all"===state.activeCat2)return void e.classList.remove("visible");const t={};if(state.db.filter((e=>"Deli"===e.br&&e.c1===state.activeCat1&&e.c2===state.activeCat2&&e.sub)).forEach((e=>{t[e.sub]=(t[e.sub]||0)+1})),0===Object.keys(t).length)return void e.classList.remove("visible");e.classList.add("visible"),e.innerHTML="";const n=document.createElement("div");n.className=`pill-l3 ${"all"===state.activeSub?"active":""}`,n.innerHTML="–í—Å–µ",n.onclick=()=>selectSub("all"),e.appendChild(n),Object.keys(t).sort().forEach((n=>{const a=document.createElement("div");a.className=`pill-l3 ${state.activeSub===n?"active":""}`,a.innerHTML=`${n} <span class="cnt">${t[n]}</span>`,a.onclick=()=>selectSub(n),e.appendChild(a)}))}function selectCat1(e){state.activeCat1=e,state.activeCat2="all",state.activeSub="all",renderLevel2(),filterData(),window.scrollTo({top:0,behavior:"smooth"})}function selectCat2(e){state.activeCat2=e,state.activeSub="all",renderLevel3Deli(),filterData(),window.scrollTo({top:0,behavior:"smooth"})}function selectSub(e){state.activeSub=e,renderLevel4Deli(),filterData(),window.scrollTo({top:0,behavior:"smooth"})}function selectBrand(e){state.activeBrand=e,renderLevel2(),filterData(),window.scrollTo({top:0,behavior:"smooth"})}function filterData(){const e=document.getElementById("searchInput").value.toLowerCase().trim();let t=state.db.filter((t=>{if(!(!e||t.nm.toLowerCase().includes(e)||t.id.toLowerCase().includes(e)))return!1;if("deli"===state.mode){if("Deli"!==t.br)return!1;if("all"!==state.activeCat1&&t.c1!==state.activeCat1)return!1;if("all"!==state.activeCat2&&t.c2!==state.activeCat2)return!1;if("all"!==state.activeSub&&t.sub!==state.activeSub)return!1}else{if("Deli"===t.br)return!1;if("all"!==state.activeBrand&&t.br!==state.activeBrand)return!1}return!0}));"price_asc"===state.sort&&t.sort(((e,t)=>getRawPrice(e)-getRawPrice(t))),state.filtered=t,document.getElementById("productsGrid").innerHTML="",state.loaded=0,document.getElementById("emptyState").classList.toggle("d-none",state.filtered.length>0),renderBatch()}function getRawPrice(e){return e.ps>0&&e.ps<e.pd?e.ps:e.pd}function renderBatch(){const e=state.filtered.slice(state.loaded,state.loaded+CONFIG.batch);if(!e.length)return;const t=document.createDocumentFragment();e.forEach((e=>{const n=document.createElement("div");n.className="col";const a=getRawPrice(e),r=state.cart[e.id]||0,l=(e.pk||"").toString().replace(/^'/,"");let c="";if(e.pr){let t="badge-promo";e.pr.toLowerCase().includes("–º–∏–Ω–∏–º")&&(t+=" badge-green"),c=`<div class="${t}">${e.pr}</div>`}n.innerHTML=`\n                <div class="product-card" onclick="openProduct('${e.id}')">\n                    <div class="chip-brand">${e.br}</div><div class="chip-pack">${l}</div>\n                    <div class="img-wrapper"><img src="img/${e.id}.png" loading="lazy" data-id="${e.id}" onerror="handleImgError(this)"><div class="cart-indicator" id="badge-${e.id}" style="${r>0?"":"display:none"}">${r}</div></div>\n                    <div class="card-info"><div class="card-title-text text-dark">${e.nm}</div><div class="text-muted small mb-1" style="font-size:0.75rem">–ê—Ä—Ç: ${e.id}</div>\n                        <div class="price-row"><div class="price-col"><span class="price-retail-label">–¶–µ–Ω–∞ –≤ –¢–∞—à–∫–µ–Ω—Ç–µ: ${e.pp>0?e.pp.toLocaleString()+" —Å—É–º":"---"}</span><div class="price-curr">${a.toLocaleString()} —Å—É–º</div></div>${c}</div>\n                    </div>\n                </div>`,t.appendChild(n)})),document.getElementById("productsGrid").appendChild(t),state.loaded+=e.length}function handleImgError(e){const t=e.getAttribute("data-id"),n=parseInt(e.getAttribute("data-step")||0);0===n?(e.setAttribute("data-step",1),e.src=`img/${t}.jpg`):1===n?(e.setAttribute("data-step",2),e.src=`img/${t}.jpeg`):(e.src="https://dummyimage.com/200x200/f0f0f0/ccc&text=–ù–µ—Ç+—Ñ–æ—Ç–æ",e.style.opacity=.5)}function initDragScroll(){const e=document.querySelectorAll(".scroll-row");e.forEach((e=>{let t=!1,n,a;e.addEventListener("mousedown",(r=>{t=!0,e.classList.add("active"),n=r.pageX-e.offsetLeft,a=e.scrollLeft})),e.addEventListener("mouseleave",(()=>{t=!1,e.classList.remove("active")})),e.addEventListener("mouseup",(()=>{t=!1,e.classList.remove("active")})),e.addEventListener("mousemove",(r=>{if(!t)return;r.preventDefault();const l=2*(r.pageX-e.offsetLeft-n);e.scrollLeft=a-l}))}))}function openProduct(e){const t=state.db.find((t=>t.id===e));if(!t)return;state.currentProduct=t,state.currentBoxSize=1,document.getElementById("modalTitle").textContent=t.nm,document.getElementById("modalArt").textContent=t.id,document.getElementById("modalRetailPrice").textContent=t.pp>0?t.pp.toLocaleString()+" —Å—É–º":"---";const n=getRawPrice(t);document.getElementById("modalDealerPrice").textContent=n.toLocaleString()+" —Å—É–º";const a=document.getElementById("modalImg");a.removeAttribute("data-step"),a.setAttribute("data-id",e),a.src=`img/${e}.png`,a.onerror=function(){handleImgError(this)};const r=String(t.pk||""),l=r.match(/\d+/g);let c=1;l&&l.length>0&&(c=Math.max(...l.map(Number))),state.currentBoxSize=c;const o=document.getElementById("modeBox");c>1?(o.disabled=!1,document.getElementById("boxLabel").textContent=`x${c}`,o.checked=!0):(o.disabled=!0,document.getElementById("boxLabel").textContent="",document.getElementById("modeUnit").checked=!0);let s=state.cart[t.id]||0,i=0;i=s>0?document.getElementById("modeBox").checked?s/c:s:1,document.getElementById("qtyInput").value=i,updateCalc(),new bootstrap.Modal(document.getElementById("productModal")).show()}function adjustQty(e){const t=document.getElementById("qtyInput");let n=(parseInt(t.value)||0)+e;n<0&&(n=0),t.value=n,updateCalc()}function updateCalc(){const e=state.currentProduct;if(!e)return;const t=document.getElementById("modeBox").checked,n=parseInt(document.getElementById("qtyInput").value)||0,a=t?state.currentBoxSize:1,r=n*a,l=getRawPrice(e);document.getElementById("calcTotalPrice").textContent=(r*l).toLocaleString()}function confirmAddToCart(){const e=state.currentProduct;if(!e)return;const t=document.getElementById("modeBox").checked,n=parseInt(document.getElementById("qtyInput").value)||0,a=t?state.currentBoxSize:1,r=n*a;r>0?state.cart[e.id]=r:delete state.cart[e.id],updateGlobalState(),bootstrap.Modal.getInstance(document.getElementById("productModal")).hide()}function showLevelUpToast(e){const t=document.createElement("div");t.className="level-up-toast",t.innerHTML=`<i class="bi bi-stars"></i> –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å! –°–∫–∏–¥–∫–∞ ${e}%`,document.getElementById("toastContainer").appendChild(t),void t.offsetWidth,t.classList.add("visible"),setTimeout((()=>{t.classList.remove("visible"),setTimeout((()=>t.remove()),500)}),3e3)}function updateGlobalState(){const e=Object.keys(state.cart).length;Object.keys(state.cart).forEach((e=>{const t=document.getElementById(`badge-${e}`);t&&(t.textContent=state.cart[e],t.style.display=state.cart[e]>0?"flex":"none")}));let t=0;Object.keys(state.cart).forEach((e=>{const n=state.db.find((t=>t.id===e));n&&(t+=getRawPrice(n)*state.cart[e])}));const n=DiscountSystem.calculate(t,!1,!1);document.getElementById("footerBaseSum").textContent=t.toLocaleString()+" —Å—É–º",document.getElementById("footerBenefit").textContent=Math.round(n.totalBenefit).toLocaleString()+" —Å—É–º",n.tierPct>lastTierPct&&lastTierPct>=0&&showLevelUpToast(n.tierPct),lastTierPct=n.tierPct;const a=document.getElementById("footerFill"),r=document.getElementById("footerGameText"),l=DiscountSystem.getRangeInfo(t);if(t>0)if(l.isMax)a.style.width="100%",r.innerHTML=`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ ${n.tierPct}% –ø–æ–ª—É—á–µ–Ω–∞!`;else{const e=l.nextLimit-l.prevLimit,n=t-l.prevLimit;let c=n/e*100;c<5&&(c=5),c>100&&(c=100),a.style.width=c+"%";const o=(l.nextLimit-t)/1e6;r.innerHTML=`–ï—â—ë ${o.toFixed(1)} –º–ª–Ω –¥–æ —Å–∫–∏–¥–∫–∏ ${l.nextPct}%`}else a.style.width="0%",r.innerHTML="–°–¥–µ–ª–∞–π—Ç–µ –∑–∞–∫–∞–∑ –¥–ª—è —Å–∫–∏–¥–∫–∏";const c=document.getElementById("cartCountBadge");e>0?(c.textContent=e,c.style.display="inline-block"):c.style.display="none",updateCartFunnel()}function updateCartItemQty(e,t){state.cart[e]&&(state.cart[e]+=t,state.cart[e]<=0&&delete state.cart[e],updateGlobalState())}function updateCartFunnel(){const e=document.getElementById("cartItemsList"),t=document.getElementById("cartFunnel"),n=Object.keys(state.cart);if(!n.length)return e.innerHTML="",document.getElementById("cartEmptyMsg").classList.remove("d-none"),void t.classList.add("d-none");document.getElementById("cartEmptyMsg").classList.add("d-none"),t.classList.remove("d-none"),e.innerHTML="";let a=0,r=0;n.forEach(((t,n)=>{const l=state.db.find((e=>e.id===t)),c=state.cart[t],o=getRawPrice(l);let s=l.pp>0?l.pp:Math.round(o/.85);a+=s*c,r+=o*c;const i=document.createElement("div");i.className="cart-item",i.innerHTML=`<div class="cart-item-head"><span class="cart-index">${n+1}.</span><div class="cart-item-title">${l.nm}</div></div><div class="cart-item-body"><div class="qty-wrapper"><span class="qty-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span><div class="cart-controls"><button class="ctrl-btn" onclick="updateCartItemQty('${t}', -1)"><i class="bi bi-dash"></i></button><div class="ctrl-val">${c}</div><button class="ctrl-btn" onclick="updateCartItemQty('${t}', 1)"><i class="bi bi-plus"></i></button></div><span class="price-per-unit">x ${o.toLocaleString()}</span></div><div class="cart-item-total"><div class="total-price-val">${(o*c).toLocaleString()}</div></div><button class="del-btn" onclick="updateCartItemQty('${t}', -${c})"><i class="bi bi-trash"></i></button></div>`,e.appendChild(i)}));const l=document.getElementById("cartPromoCheck").checked,c=document.getElementById("cartPrepayCheck").checked,o=DiscountSystem.calculate(r,c,l);document.getElementById("funnelRetail").innerText=Math.round(a).toLocaleString(),document.getElementById("funnelBase").innerText=Math.round(r).toLocaleString(),document.getElementById("funnelVol").innerText=Math.round(o.sumAfterTier).toLocaleString(),document.getElementById("chipVolPct").innerText=`-${o.tierPct}%`,document.getElementById("chipPayPct").innerText=o.payPct>0?`-${o.payPct}%`:"0%",document.getElementById("chipPayPct").className=o.payPct>0?"f-chip green":"f-chip gray",document.getElementById("funnelFinal").innerText=Math.round(o.finalSum).toLocaleString()+" —Å—É–º"}function submitOrder(){if(!Object.keys(state.cart).length)return;const e=document.getElementById("cartPromoCheck").checked,t=document.getElementById("cartPrepayCheck").checked;let n=0;const a=[];Object.keys(state.cart).forEach((t=>{const l=state.db.find((e=>e.id===t)),c=getRawPrice(l),o=c*state.cart[t];n+=o,a.push({product_id:l.id,name:l.nm,qty:state.cart[t],price_per_unit:c,total:o})}));const r=DiscountSystem.calculate(n,t,e),l={userId:state.userId,clientType:state.clientType,items:a,total_base:n,total_final:Math.round(r.finalSum),discount_tier_pct:r.tierPct,discount_pay_pct:r.payPct,is_promo:e,is_prepay:t};try{tg.sendData(JSON.stringify(l))}catch(e){alert("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–¢–µ—Å—Ç). –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º!")}}function initCalculator(){const e=document.getElementById("calcAmountSlider"),t=document.getElementById("calcPrepayCheck");e.oninput=()=>runSim(e.value,t.checked),t.onchange=()=>runSim(e.value,t.checked),runSim(50,!0)}function runSim(e,t){const n=parseFloat(e),a=1e6*n,r=DiscountSystem.calculate(a,t,!0),l=r.tierPct+r.payPct,c=a-r.finalSum;document.getElementById("calcAmountDisplay").textContent=n+" –º–ª–Ω",document.getElementById("calcTotalBenefit").textContent=(c/1e6).toFixed(2)+" –º–ª–Ω",document.getElementById("calcTotalPercent").textContent=l+"%",document.getElementById("calcFinalPrice").textContent=(r.finalSum/1e6).toFixed(2)+" –º–ª–Ω",document.getElementById("calcBaseLabel").innerText=r.tierPct+"%";const o=r.tierPct/11*100;document.getElementById("calcBaseBar").style.width=o+"%";const s=document.getElementById("calcPrepayRow"),i=document.getElementById("calcPrepayBar");t?(s.style.opacity="1",i.style.width="100%"):(s.style.opacity="0.4",i.style.width="0%")}function openCalculator(){new bootstrap.Modal(document.getElementById("calcModal")).show()}function resetFilters(){document.getElementById("searchInput").value="",setMode("deli")}
</script>
</body>
</html>

### üìù –¢–µ–∫—Å—Ç –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –≤ GitHub Desktop

**Summary:**
`Fix: Update filenames to match uploaded Excel files`

**Description:**
```text
- Updated fetch() URLs to exact filenames:
  - Database: '–ü—Ä–∞–π—Å_–ª–∏—Å—Ç_DeskForm_2025_12_10_–ó–ê–ö–ê–ó_–¥–∏–ª–µ—Ä+.xlsx'
  - Reference: '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π Deli.xlsx'
- Added 'v3.2 Custom Files' title for version tracking.
